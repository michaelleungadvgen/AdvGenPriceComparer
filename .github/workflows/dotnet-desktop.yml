name: Build AdvGen Price Comparer

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    strategy:
      matrix:
        configuration: [Debug, Release]
        platform: [x64, x86, ARM64]

    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Install .NET 8
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # Add MSBuild to the PATH
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # Restore NuGet packages
    - name: Restore packages
      run: dotnet restore AdvGenPriceComparer.sln

    # Build the Core library first
    - name: Build Core Library
      run: dotnet build AdvGenPriceComparer.Core\AdvGenPriceComparer.Core.csproj -c ${{ matrix.configuration }} --no-restore

    # Build the WinUI application with platform specification
    - name: Build WinUI Application
      run: dotnet build AdvGenPriceComparer\AdvGenPriceComparer.Desktop.WinUI.csproj -c ${{ matrix.configuration }} -p:Platform=${{ matrix.platform }} --no-restore

    # Publish self-contained for Release builds
    - name: Publish Application (Release only)
      if: matrix.configuration == 'Release'
      run: dotnet publish AdvGenPriceComparer\AdvGenPriceComparer.Desktop.WinUI.csproj -c Release -p:Platform=${{ matrix.platform }} --self-contained true -o publish\${{ matrix.platform }}

    # Upload build artifacts for Debug builds
    - name: Upload Debug Build Artifacts
      if: matrix.configuration == 'Debug'
      uses: actions/upload-artifact@v4
      with:
        name: Debug-Build-${{ matrix.platform }}
        path: |
          AdvGenPriceComparer\bin\${{ matrix.platform }}\Debug\**\*.exe
          AdvGenPriceComparer\bin\${{ matrix.platform }}\Debug\**\*.dll
          AdvGenPriceComparer\bin\${{ matrix.platform }}\Debug\**\*.pdb

    # Upload published artifacts for Release builds
    - name: Upload Release Build Artifacts
      if: matrix.configuration == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: Release-Build-${{ matrix.platform }}
        path: publish\${{ matrix.platform }}\**

  # Job for testing Python components
  test-python:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Test Python scripts
      run: |
        python -c "import sys; print('Python version:', sys.version)"
        python -c "import PyPDF2; print('PyPDF2 imported successfully')"
      continue-on-error: true